<!DOCTYPE html>
<html>
<head>
  <title>Link Fetcher</title>
  <meta charset="utf-8">
  <script src="https://maps.googleapis.com/maps/api/js?key=KEY_HERE"></script>
</head>
<body>
  <script>
    /**
     * Main function to find the next panorama in a given direction.
     * Can take either a panoId or a lat/lng pair.
     * @param {number|null} lat - Current latitude (or null if using panoId).
     * @param {number|null} lng - Current longitude (or null if using panoId).
     * @param {number} currentHeading - Heading in degrees.
     * @param {'w'|'s'} direction - Desired direction.
     * @param {string|null} panoId - Optional pano ID.
     */
    async function findNextPano(lat, lng, currentHeading, direction, panoId = null) {
      const svService = new google.maps.StreetViewService();

      function getPanoramaById(panoId) {
        return new Promise((resolve, reject) => {
          svService.getPanorama({ pano: panoId }, (data, status) => {
            if (status === 'OK') resolve(data);
            else reject(new Error("Pano by ID not found"));
          });
        });
      }

      function getPanoramaAtLocation(lat, lng) {
        return new Promise((resolve, reject) => {
          svService.getPanorama({ location: { lat, lng }, radius: 50 }, (data, status) => {
            if (status === 'OK') resolve(data);
            else reject(new Error("Pano by location not found"));
          });
        });
      }

      try {
        let data;

        // Use panoId if provided, otherwise use lat/lng
        if (panoId) {
          data = await getPanoramaById(panoId);
        } else {
          data = await getPanoramaAtLocation(lat, lng);
        }

        const links = data.links;
        if (!links || links.length === 0) throw new Error("No links found");

        // Determine desired heading (reverse for 's')
        let targetHeading = currentHeading;
        if (direction === 's') {
          targetHeading = (currentHeading + 180) % 360;
        }

        // Find best-matching link
        let bestLink = null;
        let minDiff = 360;
        for (const link of links) {
          let diff = Math.abs(link.heading - targetHeading);
          if (diff > 180) diff = 360 - diff;
          if (diff < minDiff) {
            minDiff = diff;
            bestLink = link;
          }
        }

        if (!bestLink) throw new Error("No suitable link found");

        // Output just the panoId (Playwright reads this)
        console.log(JSON.stringify(bestLink.pano));

      } catch (err) {
        console.error("Error:", err.message);
      }
    }

    // Expose for Playwright
    window.findNextPano = findNextPano;
  </script>
</body>
</html>
